#!/usr/bin/env bash

# #######################################################################
# this script aims to run jar file which is built on spring boot 2.3.12+.
# it supports many modes. see config/services.ini for detail.
#
# author: Leo ning <windywany@gmail.com>
# date: 2022-08-06
# version: 1.0.0
#
### do not edit this file unless you known what you are doing.###########
#########################################################################
. "$JARUN_BASE_DIR/bin/lib/common.sh"

function stop_on_remote {
    log_info "Stopping the $APP_NAME on $(clr_str blue $1):$(clr_str red $SERVER_PORT)"
    ORIG_ARGS[13]=stop
    if [ "$1" = "localhost" ] || [ "$1" = "127.0.0.1" ] || [ "$1" = $(hostname) ]; then
        log_debug "exec $JARUN_BASE_DIR/bin/rcall.sh ${ORIG_ARGS[@]}"
        bash "${JARUN_BASE_DIR}/bin/rcall.sh" "${ORIG_ARGS[@]}"
    else
        log_debug "ssh ${APP_USER}${1} $JARUN_BASE_DIR/bin/rcall.sh ${ORIG_ARGS[@]}"
        ssh "${APP_USER}${1}" "export XDEBUG=${XDEBUG} && $JARUN_BASE_DIR/bin/rcall.sh" "${ORIG_ARGS[@]}"
    fi
}

# run jar in host machine
function stop_application_jar {
    if [ -n "${RUN_ON_HOSTS[@]}" ]; then
        for host in ${RUN_ON_HOSTS}; do
            if ! stop_on_remote $host; then
                return 1
            fi
        done
        return 0
    fi

    CPID=$(ps aux | grep "=$SERVICE_HASH" | grep -v grep | awk '{print $2}' 2>/dev/null)

    echo -n "Stopping $SERVICE_NAME($CPID) "

    while [[ -n $CPID ]]; do
        PID=$(ps aux | grep "=${SERVICE_HASH}" | grep -v grep | awk '{print $2}' 2>/dev/null)

        echo -n '.'

        if [ "$CPID" == "$PID" ]; then
            kill $CPID >/dev/null 2>&1
            sleep 1
        else
            break
        fi
    done

    echo -n -e " [$(clr_str green Done)]\n"
    return 0
}

# 保留原始参数（去除hosts)
ORIG_ARGS=("$1" "$2" "$3" "$4" "$5" "$6" "$7" "''" "$9" "${10}" "${11}" "${RUN_MODE}" "${ENV}")

# 初始化变量
APP_ID=$(str_trim_quote "${1}")
APP_NAME=$(str_trim_quote "${2}")
APP_DIR=$(str_trim_quote "${3}")
APP_PATH="${JARUN_BASE_DIR}/${APP_DIR}"
APP_PORT=$(str_trim_quote "${4}")
ACTIVE_PROFILES=$(str_trim_quote "${5}")
APP_LIBS=$(str_trim_quote "${6}")
LOG_DIR=$(str_trim_quote "${7}")
RUN_ON_HOSTS=$(str_trim_quote "${8}")
APP_ARGS=$(str_trim_quote "${9}")
APP_JAR=$(str_trim_quote "${10}")
# 检测启动方式
if [[ $(str_trim_quote "${11}") =~ ^true$ ]]; then
    APP_LAUNCHER='launcher'
else
    APP_LAUNCHER='jar'
fi

if ! prepare_args; then
    exit 1
fi

if [ $# -eq 11 ]; then
    print_envs
fi

case "${RUN_MODE}_${APP_LAUNCHER}" in
nohup_*)
    stop_application_jar
    ;;
*)
    log_error "Unknown Running Mode: " $(clr_str red "${RUN_MODE}_${APP_LAUNCHER}")
    exit 1
    ;;
esac
### do not edit above codes #############################################
#########################################################################
